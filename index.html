<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pose Detection Demo (Jab / Guard)</title>

  <!-- TensorFlow & Teachable Machine Pose -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@2.0.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8/dist/teachablemachine-pose.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: #0a0a0a;
      color: #fff;
      margin: 0;
      padding: 0;
    }
    h1 {
      margin-top: 30px;
      color: #00ff99;
    }
    #webcam-container canvas {
      margin-top: 20px;
      border-radius: 10px;
      border: 2px solid #00ff99;
    }
    #label-container div {
      font-size: 18px;
      margin-top: 10px;
      background: rgba(0, 255, 153, 0.1);
      padding: 8px;
      border-radius: 8px;
      width: 220px;
      margin-left: auto;
      margin-right: auto;
      transition: background 0.3s;
    }
    button {
      background: #00ff99;
      color: #111;
      font-size: 18px;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      cursor: pointer;
      margin-top: 20px;
    }
    button:hover {
      background: #00cc77;
    }
    #active-pose {
      margin-top: 30px;
      font-size: 28px;
      font-weight: bold;
      text-transform: uppercase;
      padding: 15px 30px;
      border-radius: 12px;
      display: inline-block;
      background: #333;
      border: 2px solid #555;
      transition: all 0.3s ease;
    }
    #active-pose.active {
      background: #00ff99;
      color: #111;
      border-color: #00ff99;
      box-shadow: 0 0 20px #00ff99;
    }
  </style>
</head>

<body>
  <h1>Pose Detection Demo (Jab / Guard)</h1>
  <button type="button" onclick="init()">Start Webcam</button>

  <div id="webcam-container"></div>
  <div id="label-container"></div>
  <div id="active-pose">No Pose Detected</div>

  <script type="text/javascript">
    const URL = "./model/";
    let model, webcam, ctx, labelContainer, maxPredictions;
    let canvas;

    async function init() {
      const modelURL = URL + "model.json";
      const metadataURL = URL + "metadata.json";

      // Load model
      model = await tmPose.load(modelURL, metadataURL);
      maxPredictions = model.getTotalClasses();

      // Set up webcam
      const size = 400;
      const flip = true;
      webcam = new tmPose.Webcam(size, size, flip);

      // Request camera access
      await webcam.setup({ facingMode: "user" });
      await webcam.play();

      // Create canvas
      canvas = document.createElement("canvas");
      canvas.width = size;
      canvas.height = size;
      document.getElementById("webcam-container").appendChild(canvas);
      ctx = canvas.getContext("2d");

      // Create label boxes
      labelContainer = document.getElementById("label-container");
      for (let i = 0; i < maxPredictions; i++) {
        labelContainer.appendChild(document.createElement("div"));
      }

      // Start loop
      window.requestAnimationFrame(loop);
    }

    async function loop() {
      webcam.update();
      await predict();
      window.requestAnimationFrame(loop);
    }

    async function predict() {
      if (!webcam.canvas) return;

      // Draw webcam feed
      ctx.drawImage(webcam.canvas, 0, 0, canvas.width, canvas.height);

      // Estimate pose
      const { pose, posenetOutput } = await model.estimatePose(webcam.canvas);
      const prediction = await model.predict(posenetOutput);

      // Draw pose lines (slightly transparent)
      ctx.globalAlpha = 0.8;
      model.drawPose(pose, ctx);
      ctx.globalAlpha = 1.0;

      // Find highest prediction
      let highestClass = "";
      let highestProb = 0;

      for (let i = 0; i < maxPredictions; i++) {
        const className = prediction[i].className;
        const probability = prediction[i].probability;
        const percent = (probability * 100).toFixed(1);

        labelContainer.childNodes[i].innerHTML = `${className}: ${percent}%`;

        if (probability > highestProb) {
          highestProb = probability;
          highestClass = className;
        }
      }

      // Show active pose
      const activePose = document.getElementById("active-pose");
      if (highestProb > 0.75) {
        activePose.textContent = highestClass;
        activePose.classList.add("active");
      } else {
        activePose.textContent = "No Pose Detected";
        activePose.classList.remove("active");
      }
    }
  </script>
</body>
</html>
